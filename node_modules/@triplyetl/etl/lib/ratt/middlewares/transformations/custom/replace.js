import { has, set as lodashSet } from "lodash-es";
import { getTypedValFromRecord } from "../../../../generic/Context.js";
import { addMwCallSiteToError } from "../../../../utils/index.js";
export default function replace(opts) {
    return addMwCallSiteToError(async function _replace(ctx, next) {
        if (opts.fromKey === opts.toKey)
            throw new Error(`"fromKey" and "toKey" are both '${opts.fromKey}'. Use the 'change' middleware instead`);
        if (!has(ctx.record, opts.fromKey))
            throw new Error(`Could not find key '${opts.fromKey}' in the record`);
        if (!has(ctx.record, opts.toKey))
            throw new Error(`Could not find key '${opts.toKey}' in the record`);
        const val = getTypedValFromRecord(ctx, opts.fromKey, opts.type);
        if (opts.change) {
            lodashSet(ctx.record, opts.toKey, await opts.change(val));
        }
        else {
            lodashSet(ctx.record, opts.toKey, val);
        }
        return next();
    }, { sourceFuncName: "_replace" });
}
//# sourceMappingURL=replace.js.map