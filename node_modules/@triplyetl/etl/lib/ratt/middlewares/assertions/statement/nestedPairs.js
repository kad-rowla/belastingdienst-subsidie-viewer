import { unset } from "lodash-es";
import { convertMwListToMiddleware, randomHash } from "../../../../utils/index.js";
import addSkolemIri from "../../transformations/addSkolemIri.js";
import { isJPath } from "../term/jpath.js";
import quad, { isPair, isSPG } from "./rdf/quad.js";
function _nestedPairs(graphOrSubject, subjectOrPredicate, predicateOrObject, objectOrPair, ...pairs) {
    let S, P, O, G;
    if (isSPG(objectOrPair)) {
        G = graphOrSubject;
        S = subjectOrPredicate;
        P = predicateOrObject;
        O = objectOrPair;
    }
    else {
        pairs = objectOrPair !== undefined ? [objectOrPair, ...pairs] : pairs;
        S = graphOrSubject;
        P = subjectOrPredicate;
        O = predicateOrObject;
    }
    if (isJPath(O)) {
        throw new Error("This must be a bug: a JSON Path expression can not make a good RDF Object");
    }
    const mws = [];
    const sentinalKey = "$nestedPairs-" + randomHash();
    if (O === undefined) {
        mws.push(addSkolemIri({ key: sentinalKey }));
    }
    mws.push(quad(S, P, O ?? sentinalKey, G), ...pairs.map((pair) => quad(O ?? sentinalKey, pair[0], pair[1], G)));
    if (O === undefined) {
        mws.push(async (ctx, next) => {
            unset(ctx.record, sentinalKey);
            return next();
        });
    }
    return mws;
}
function nestedPairs(graphOrSubject, subjectOrPredicate, predicateOrObject, objectOrPair, ...pairs) {
    // this will result in a Skolem Iri being used:
    let predicateOrObjectOrUndefined;
    if (isPair(predicateOrObject)) {
        if (isPair(objectOrPair)) {
            pairs.unshift(objectOrPair);
        }
        if (predicateOrObject !== undefined)
            pairs.unshift(predicateOrObject);
        predicateOrObjectOrUndefined = undefined;
    }
    else {
        predicateOrObjectOrUndefined = predicateOrObject;
    }
    return convertMwListToMiddleware(_nestedPairs(graphOrSubject, subjectOrPredicate, predicateOrObjectOrUndefined, objectOrPair, ...pairs), "_nestedPairs");
}
export default nestedPairs;
//# sourceMappingURL=nestedPairs.js.map