import getCurrentLine from "get-current-line";
import { Key, Middleware, MiddlewareList } from "../../index.js";
import { UseWhenCb, whenMw } from "../../Etl.js";

/**
 * Run one or more middlewares when the specified key does not exist or
 * exists but contains an empty value.
 *
 * @remarks
 * The value for a key is considered empty if it is `undefined`, `null`, the
 * empty string (`''`), the empty array (`[]`), or the empty object (`{}`).
 *
 * @param key - A key that may or may not exist in the Etl Record.
 *
 * @param middleware - An array with zero or more middlewares.
 *
 * @example
 * The following snippet only asserts information about creative works that
 * are not restricted under some license.
 *
 * ```ts
 * fromJson([
 *   { license: 'some license', id: '123', ... },
 *   { id: '456', ...},
 * ]),
 * whenNot('license', [
 *   triple(iri(prefix.image, 'id'), a, sdo.CreativeWork),
 *   ...,
 * ]),
 * ```
 */
export default function <R = unknown>(
  when: Key | UseWhenCb<R>,
  ...middlewaresArray: MiddlewareList<R>
): Array<Middleware<R>> {
  const whenFn: UseWhenCb<R> =
    typeof when === "function" ? (ctx) => !when(ctx) : (ctx) => !ctx.hasKey(when) || ctx.isEmpty(when);
  whenFn.sourceFuncName = "_whenNot";
  whenFn.callsite = getCurrentLine({ frames: 2 });
  return whenMw(whenFn, middlewaresArray);
}
