import { cloneDeep } from "lodash-es";
import Context from "../generic/Context.js";
import { Middleware } from "../generic/index.js";
import { addMwCallSiteToError } from "../utils/index.js";

function createTraceInfo(ctx: Context) {
  return {
    fromMwIndex: [...ctx.app["currentMwIndices"]],
    recordId: ctx.recordId,
    record: cloneDeep(ctx.record),
    quads: ctx.store.toNquadsString(),
  };
}

// TODO @DocumentationTeam: add TS doc comment here
export default function traceStart(): Middleware {
  return addMwCallSiteToError(
    async function _traceStart(ctx, next) {
      if (ctx["traceInfo"]) throw new Error("Trace info already exist. Did you forget to add a traceEnd() somewhere?");
      ctx["traceInfo"] = createTraceInfo(ctx);
      return next();
    },
    { sourceFuncName: "_traceStart" },
  );
}

export function setTraceErrorInfo(ctx: Context) {
  ctx["traceError"] = createTraceInfo(ctx);
}
