import { Middleware } from "../../generic/index.js";
import { SourceGetter, StringSourceInfo } from "../../generic/locations/sources/index.js";
import { addMwCallSiteToError } from "../../utils/index.js";
import * as speedy from "@triplydb/speedy-memory";

/**
 * Runs a SPARQL update query
 * @param query The query to run. Can be a SPARQL query, saved query or a query file
 * @returns update query middleware
 */
export default function update(query: string | SourceGetter<"string", StringSourceInfo>): Middleware {
  return addMwCallSiteToError(
    async function _runUpdateQuery(ctx, next) {
      const engine = speedy.newEngine(ctx.store);
      if (typeof query !== "string") {
        query = await (await query.get(ctx.app, "string"))[0].getString();
      }
      await engine.update(query);
      return next();
    },
    { sourceFuncName: "_sparql.update" },
  );
}
