prefix dct: <http://purl.org/dc/terms/>
prefix owl: <http://www.w3.org/2002/07/owl#>
prefix qudt: <http://qudt.org/schema/qudt/>
prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>
prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#>
prefix skos: <http://www.w3.org/2004/02/skos/core#>
prefix xsd: <http://www.w3.org/2001/XMLSchema#>
select ?key ?vsc_category ?vsc_label ?vsc_parent ?vsc_domain ?vsc_range ?vsc_description {
  {
    select ?alias ?key ?vsc_category ?vsc_label ?vsc_parent ?vsc_domain ?vsc_range ?vsc_description {
      bind($prefixIn as ?alias)
      bind($iriIn as ?prefix)

      ?term a [].
      filter(strstarts(str(?term),str(?prefix)))
      bind(strafter(str(?term),str(?prefix)) as ?key)
      filter(?key != '')

      {
        ?term a/rdfs:subClassOf* ?class.
        filter(?class in ( owl:AnnotationProperty,
                           owl:DatatypeProperty,
                           owl:ObjectProperty,
                           rdf:Property ))
        bind('property' as ?category)
      } union {
        ?term a/rdfs:subClassOf* ?class.
        filter(?class in ( owl:Class,
                           rdfs:Class ))
        bind('class' as ?category)
      } union {
        ?term a/rdfs:subClassOf* ?class.
        filter(?class in ( qudt:Unit ))
        bind('unit of measure' as ?category)
      } union {
        ?term a/rdfs:subClassOf* ?class.
        filter(?class in ( rdfs:Datatype ))
        bind('datatype' as ?category)
      } union {
        ?term a [].
        filter not exists {
          ?term a/rdfs:subClassOf* ?class.
          filter(?class in ( owl:AnnotationProperty,
                             owl:Class,
                             owl:DatatypeProperty,
                             owl:ObjectProperty,
                             qudt:Unit,
                             rdf:Property,
                             rdfs:Class,
                             rdfs:Datatype ))
        }
        bind('instance' as ?category)
      }

      optional {
        {
          ?term rdfs:label|skos:prefLabel ?label.
          filter(langmatches(lang(?label), 'en'))
        } union {
          filter not exists {
            ?term rdfs:label|skos:prefLabel ?labelX.
            filter(langmatches(lang(?labelX), 'en'))
          }
          ?term rdfs:label|skos:prefLabel ?label.
          filter(!langmatches(lang(?label), 'en') && langmatches(lang(?label), 'nl'))
        } union {
          filter not exists {
            ?term rdfs:label|skos:prefLabel ?labelX.
            filter(langmatches(lang(?labelX), 'en'))
          }
          filter not exists {
            ?term rdfs:label|skos:prefLabel ?labelX.
            filter(!langmatches(lang(?labelX), 'en') && langmatches(lang(?labelX), 'nl'))
          }
          ?term rdfs:label|skos:prefLabel ?label.
          filter(datatype(?label) in ( qudt:LatexString,
                                       xsd:string ))
        }
      }

      optional { ?term rdfs:subClassOf|rdfs:subPropertyOf ?parent0. }
      bind(
        if(bound(?parent0),
           if(strstarts(str(?parent0),str(?prefix)),
              concat(?alias,':',strafter(str(?parent0),str(?prefix))),
              str(?parent0)),
           '') as ?parent)

      optional {
        ?term rdfs:domain [].
        {
          select ?term (group_concat(distinct ?domain2;separator=' or ') as ?domain) {
            {
              ?term rdfs:domain ?domain1.
              filter(!strstarts(str(?domain1),'https://triplydb.com/.well-known/genid/'))
            } union {
              ?term rdfs:domain ?skolem.
              filter(strstarts(str(?skolem),'https://triplydb.com/.well-known/genid/'))
              ?skolem owl:unionOf/rdf:rest*/rdf:first ?domain1.
            }
            bind(
              if(strstarts(str(?domain1),str($iriIn)),
              concat($prefixIn,':',strafter(str(?domain1),str($iriIn))),
              str(?domain1)) as ?domain2)
          }
          group by ?term
        }
      }

      optional {
        ?term rdfs:range [].
        {
          select ?term (group_concat(distinct ?range2;separator=' or ') as ?range) {
            {
              ?term rdfs:range ?range1.
              filter(!strstarts(str(?range1),'https://triplydb.com/.well-known/genid/'))
            } union {
              ?term rdfs:range ?skolem.
              filter(strstarts(str(?skolem),'https://triplydb.com/.well-known/genid/'))
              ?skolem owl:unionOf/rdf:rest*/rdf:first ?range1.
            }
            bind(
              if(strstarts(str(?range1),str($iriIn)),
              concat($prefixIn,':',strafter(str(?range1),str($iriIn))),
              str(?range1)) as ?range2)
          }
          group by ?term
        }
       }

      optional {
        {
          ?term dct:description|rdfs:comment|skos:definition ?description0.
          filter(langmatches(lang(?description0), 'en'))
        } union {
          filter not exists {
            ?term dct:description|rdfs:comment|skos:definition ?descriptionX.
            filter(langmatches(lang(?descriptionX), 'en'))
          }
          ?term dct:description|rdfs:comment|skos:definition ?description0.
          filter(!langmatches(lang(?description0), 'en') && langmatches(lang(?description0), 'nl'))
        } union {
          filter not exists {
            ?term dct:description|rdfs:comment|skos:definition ?descriptionX.
            filter(langmatches(lang(?descriptionX), 'en'))
          }
          filter not exists {
            ?term dct:description|rdfs:comment|skos:definition ?descriptionX.
            filter(!langmatches(lang(?descriptionX), 'en') && langmatches(lang(?descriptionX), 'nl'))
          }
          ?term dct:description|rdfs:comment|skos:definition ?description0.
          filter(datatype(?description0) in ( qudt:LatexString,
                                              xsd:string ))
        }
        bind(replace(replace(str(?description0),'\\\n',''),'\n  * ','') as ?description)
      }

      bind(str(?category) as ?vsc_category)
      bind(if(!bound(?label), '', str(?label)) as ?vsc_label)
      bind(if(!bound(?parent), '', str(?parent)) as ?vsc_parent)
      bind(if(!bound(?domain), '', str(?domain)) as ?vsc_domain)
      bind(if(!bound(?range), '', str(?range)) as ?vsc_range)
      bind(if(!bound(?description), '', str(?description)) as ?vsc_description)
    }
    group by ?alias ?key ?vsc_category ?vsc_label ?vsc_parent ?vsc_domain ?vsc_range ?vsc_description
    order by ?alias ?key
  }
}
group by ?alias ?key ?vsc_category ?vsc_label ?vsc_parent ?vsc_domain ?vsc_range ?vsc_description
order by ?alias