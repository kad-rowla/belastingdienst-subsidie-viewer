include:
  - project: "shared/ci-utils"
    file: ".yarn.yml"

stages:
  - test
  - publish

.template:
  install:
    - if [ "$(npm config get @triplydb:registry)" = "undefined" ]; then npm config set @triplydb:registry=https://git.triply.cc/api/v4/packages/npm/; fi
    - if [ "$(npm config get @triplyetl:registry)" = "undefined" ]; then npm config set @triplyetl:registry=https://git.triply.cc/api/v4/packages/npm/; fi
    - npm config list | grep '//git.triply.cc/api/v4/packages/npm/:_authToken' > /dev/null || npm config set '//git.triply.cc/api/v4/packages/npm/:_authToken'="${CI_JOB_TOKEN}"
    - npm install --no-fund --ignore-scripts

image: node:18.9.0-bullseye-slim

install-and-test:
  stage: test
  script:
    - !reference [.template, install]
    - npm run test
  rules:
    - if: $CI_COMMIT_BRANCH =~ /^v-.*$/
      when: never
    - if: $CI_PIPELINE_SOURCE == "push"

install-and-test-packed:
  stage: test
  variables:
    CI: "true"
  script:
    - !reference [.template, install]
    - npm run test
    - npm pack
    - tar -xzf triplyetl-shapefile-*.tgz
  rules:
    - if: $CI_COMMIT_BRANCH =~ /^v-.*$/

publish-npm-gitlab:
  stage: publish
  cache: !reference [.readOnlyYarnCache]
  script:
    - !reference [.template, install]
    - |
      echo "//${CI_SERVER_HOST}/api/v4/projects/463/packages/npm/:_authToken=${CI_JOB_TOKEN}" > .npmrc
    - npm publish
  only:
    refs:
      - /^v-\d+\.\d+\.\d+$/
