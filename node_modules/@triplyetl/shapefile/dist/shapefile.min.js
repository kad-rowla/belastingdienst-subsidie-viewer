// https://github.com/mbostock/shapefile Version 1.0.1. Copyright 2023 Mike Bostock.
!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports):"function"==typeof define&&define.amd?define(["exports"],n):n(e.shapefile={})}(this,function(e){"use strict";function o(e){return new n(e instanceof Uint8Array?e:new Uint8Array(e))}function n(e){this._array=e}n.prototype.read=function(){var e=this._array;return this._array=null,Promise.resolve(e?{done:!1,value:e}:{done:!0,value:void 0})},n.prototype.cancel=function(){return this._array=null,Promise.resolve()};var t=function(e){return fetch(e).then(function(e){return e.body&&e.body.getReader?e.body.getReader():e.arrayBuffer().then(o)})},r=function(r){return new Promise(function(e,n){var t=new XMLHttpRequest;t.responseType="arraybuffer",t.onload=function(){e(o(t.response))},t.onerror=n,t.ontimeout=n,t.open("GET",r,!0),t.send()})};function i(e){return("function"==typeof fetch?t:r)(e)}function u(e){return"function"==typeof e.read?e:e.getReader()}var a=new Uint8Array(0);function s(e){return"function"==typeof e.slice?e:new c("function"==typeof e.read?e:e.getReader())}function c(e){this._source=e,this._array=a,this._index=0}c.prototype.read=function(){var r=this,o=r._array.subarray(r._index);return r._source.read().then(function(e){return r._array=a,r._index=0,e.done?0<o.length?{done:!1,value:o}:{done:!0,value:void 0}:{done:!1,value:(n=o,e=e.value,n.length?e.length?((t=new Uint8Array(n.length+e.length)).set(n),t.set(e,n.length),t):n:e)};var n,t})},c.prototype.slice=function(t){if((t|=0)<0)throw new Error("invalid length");var r,o=this,i=this._array.length-this._index;return this._index+t<=this._array.length?Promise.resolve(this._array.subarray(this._index,this._index+=t)):((r=new Uint8Array(t)).set(this._array.subarray(this._index)),function n(){return o._source.read().then(function(e){return e.done?(o._array=a,(o._index=0)<i?r.subarray(0,i):null):i+e.value.length>=t?(o._array=e.value,o._index=t-i,r.set(e.value.subarray(0,t-i),i),r):(r.set(e.value,i),i+=e.value.length,n())})}())},c.prototype.cancel=function(){return this._source.cancel()};function f(e){return!(e=e.trim())||isNaN(e=+e)?null:e}var l={B:f,C:function(e){return e.trim()||null},D:function(e){return new Date(+e.substring(0,4),e.substring(4,6)-1,+e.substring(6,8))},F:f,L:function(e){return!/^[nf]$/i.test(e)&&(!!/^[yt]$/i.test(e)||null)},M:f,N:f},h=function(e){return new DataView(e.buffer,e.byteOffset,e.byteLength)},d=function(t,r){return(t=s(t)).slice(32).then(function(e){var n=h(e);return t.slice(n.getUint16(8,!0)-32).then(function(e){return new y(t,r,n,h(e))})})};function y(e,n,t,r){this._source=e,this._decode=n.decode.bind(n),this._recordLength=t.getUint16(10,!0),this._fields=[];for(var o=0;13!==r.getUint8(o);o+=32){for(var i=0;i<11&&0!==r.getUint8(o+i);++i);this._fields.push({name:this._decode(new Uint8Array(r.buffer,r.byteOffset+o,i)),type:String.fromCharCode(r.getUint8(o+11)),length:r.getUint8(o+16)})}}var g=y.prototype;g.read=function(){var r=this,o=1;return r._source.slice(r._recordLength).then(function(t){return t&&26!==t[0]?{done:!1,value:r._fields.reduce(function(e,n){return e[n.name]=l[n.type](r._decode(t.subarray(o,o+=n.length))),e},{})}:{done:!0,value:void 0}})},g.cancel=function(){return this._source.cancel()};function p(e){for(var n=40,t=e.getInt32(36,!0),r=new Array(t),o=0;o<t;++o,n+=16)r[o]=[e.getFloat64(n,!0),e.getFloat64(n+8,!0)];return{type:"MultiPoint",coordinates:r}}function v(e){return{type:"Point",coordinates:[e.getFloat64(4,!0),e.getFloat64(12,!0)]}}function _(e){for(var n=44,t=e.getInt32(36,!0),r=e.getInt32(40,!0),o=new Array(t),i=new Array(r),u=[],a=[],s=0;s<t;++s,n+=4)o[s]=e.getInt32(n,!0);for(s=0;s<r;++s,n+=16)i[s]=[e.getFloat64(n,!0),e.getFloat64(n+8,!0)];return o.forEach(function(e,n){e=i.slice(e,o[n+1]);!function(e){if((n=e.length)<4)return;var n,t=0,r=e[n-1][1]*e[0][0]-e[n-1][0]*e[0][1];for(;++t<n;)r+=e[t-1][1]*e[t][0]-e[t-1][0]*e[t][1];return 0<=r}(e)?a.push(e):u.push([e])}),a.forEach(function(n){u.some(function(e){if(function(e,n){var t,r=-1,o=n.length;for(;++r<o;)if(t=function(e,n){for(var t=n[0],r=n[1],o=-1,i=0,u=e.length,a=u-1;i<u;a=i++){var s=e[i],c=s[0],f=s[1],l=e[a],h=l[0],d=l[1];if(function(e,n,t){var r,o=t[0]-e[0],t=t[1]-e[1];return 0==o&&0==t||(r=n[0]-e[0],n=n[1]-e[1],!(0==r&&0==n||(e=(o*r+t*n)/(r*r+n*n))<0||1<e||0!=e&&1!=e&&(e*r!=o||e*n!=t)))}(s,l,n))return 0;r<f!=r<d&&t<(h-c)*(r-f)/(d-f)+c&&(o=-o)}return o}(e,n[r]))return 0<t;return}(e[0],n))return e.push(n),!0})||u.push([n])}),1===u.length?{type:"Polygon",coordinates:u[0]}:{type:"MultiPolygon",coordinates:u}}function b(e){for(var n=44,t=e.getInt32(36,!0),r=e.getInt32(40,!0),o=new Array(t),i=new Array(r),u=0;u<t;++u,n+=4)o[u]=e.getInt32(n,!0);for(u=0;u<r;++u,n+=16)i[u]=[e.getFloat64(n,!0),e.getFloat64(n+8,!0)];return 1===t?{type:"LineString",coordinates:i}:{type:"MultiLineString",coordinates:o.map(function(e,n){return i.slice(e,o[n+1])})}}function w(e,n){var t=new Uint8Array(e.length+n.length);return t.set(e,0),t.set(n,e.length),t}var x={0:function(){return null},1:v,3:b,5:_,8:p,11:v,13:b,15:_,18:p,21:v,23:b,25:_,28:p},m=function(n){return(n=s(n)).slice(100).then(function(e){return new A(n,h(e))})};function A(e,n){var t=n.getInt32(32,!0);if(!(t in x))throw new Error("unsupported shape type: "+t);this._source=e,this._type=t,this._index=0,this._parse=x[t],this.bbox=[n.getFloat64(36,!0),n.getFloat64(44,!0),n.getFloat64(52,!0),n.getFloat64(60,!0)]}g=A.prototype;function U(){}g.read=function(){var i=this;return++i._index,i._source.slice(12).then(function(t){var r;return null==t?{done:!0,value:void 0}:(r=h(t),o());function o(){var e=2*r.getInt32(4,!1)-4,n=r.getInt32(8,!0);return e<0||n&&n!==i._type?function n(){return i._source.slice(4).then(function(e){return null==e?{done:!0,value:void 0}:((r=h(t=w(t.slice(4),e))).getInt32(0,!1)!==i._index?n:o)()})}():i._source.slice(e).then(function(e){return{done:!1,value:n?i._parse(h(w(t.slice(8),e))):null}})}})},g.cancel=function(){return this._source.cancel()};function F(e,n){this._shp=e,this._dbf=n,this.bbox=e.bbox}g=F.prototype;function P(e,n,r){return"string"==typeof n?(/\.dbf$/.test(n)||(n+=".dbf"),n=i(n)):n instanceof ArrayBuffer||n instanceof Uint8Array?n=o(n):null!=n&&(n=u(n)),e=("string"==typeof e?(/\.shp$/.test(e)||(e+=".shp"),void 0===n&&(n=i(e.substring(0,e.length-4)+".dbf").catch(function(){})),i):e instanceof ArrayBuffer||e instanceof Uint8Array?o:u)(e),Promise.all([e,n]).then(function(e){var n=e[0],e=e[1],t="windows-1252";return r&&null!=r.encoding&&(t=r.encoding),n=n,t=(e=e)&&new TextDecoder(t),Promise.all([m(n),e&&d(e,t)]).then(function(e){return new F(e[0],e[1])})})}g.read=function(){return Promise.all([this._dbf?this._dbf.read():{value:{}},this._shp.read()]).then(function(e){var n=e[0],e=e[1];return e.done?e:{done:!1,value:{type:"Feature",properties:n.value,geometry:e.value}}})},g.cancel=function(){return Promise.all([this._dbf&&this._dbf.cancel(),this._shp.cancel()]).then(U)},e.open=P,e.openShp=function(e,n){return e=("string"==typeof e?(/\.shp$/.test(e)||(e+=".shp"),i):e instanceof ArrayBuffer||e instanceof Uint8Array?o:u)(e),Promise.resolve(e).then(m)},e.openDbf=function(e,n){var t="windows-1252";return n&&null!=n.encoding&&(t=n.encoding),t=new TextDecoder(t),e=("string"==typeof e?(/\.dbf$/.test(e)||(e+=".dbf"),i):e instanceof ArrayBuffer||e instanceof Uint8Array?o:u)(e),Promise.resolve(e).then(function(e){return d(e,t)})},e.read=function(e,n,t){return P(e,n,t).then(function(t){var r=[],o={type:"FeatureCollection",features:r,bbox:t.bbox};return t.read().then(function e(n){return n.done?o:(r.push(n.value),t.read().then(e))})})},Object.defineProperty(e,"__esModule",{value:!0})});