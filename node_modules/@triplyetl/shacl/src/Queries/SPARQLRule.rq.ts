import { type NamedNode } from '@triplydb/data-factory/Terms.js'
import { type BlankNodeOrIRI } from '../Types.js'
export default (shape: NamedNode, rule?: BlankNodeOrIRI): string => `
prefix sh: <http://www.w3.org/ns/shacl#> 
prefix xsd: <http://www.w3.org/2001/XMLSchema#>

select ?shape ?rule (concat(coalesce(?declarations, ''), "\\n", ?construct) as ?query) where {
  select ?shape ?construct ?rule (group_concat(?declaration; separator="\\n") as ?declarations)
  where {
      ?shape sh:rule ?rule .
      ?rule a sh:SPARQLRule; sh:construct ?construct .
      optional {
        ?rule sh:prefixes/sh:declare ?declare .
        ?declare sh:prefix ?prefix; sh:namespace ?namespace .
        bind(concat('prefix ', ?prefix, ': ', '<', str(?namespace), '>') as ?declaration)
      }
      filter (?shape = <${shape.value}> )
      ${rule === undefined ? '' : `filter (?rule = <${rule.value}> )`}
  } 
  group by ?shape ?construct ?rule
}`
